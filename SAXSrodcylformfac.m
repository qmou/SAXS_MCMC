function [In, Iq] = SAXSrodcylformfac(rho)% take density map rho as imputglobal nx	nxf = nx;% can be smaller than in SAXSpreprodcyl, to speed up calculationnxfd2=nxf/2;iqcent=nxfd2+1;Ampl=fft2(rho);Ampl=fftshift(Ampl);  %center of grid (nxd2+1) is at q=0% ................. I(q)=|A(q)|^2 .....................Iq=abs(Ampl).^2;iq1=(1:nx)-iqcent;%elementary squareq1ad2=pi*iq1/nx+0.00000001;   % q1*a/2 = iq1c*2pi/(nx*a) *a/2formf=(sin(q1ad2)./q1ad2).^2;Iscatt = zeros(nxf,1);iqmin=iqcent-nxfd2;iqmax=iqcent+nxfd2-1;parfor iq1=iqmin:iqmax	%    temp1 = zeros(nxf,1);    %temp2 = zeros(nxf,1);    formx = formf(iq1);    for iq2=iqmin:iqmax  %        formy = formf(iq2);        for iq3=iqcent:iqcent  %thin sheet along q3         qabs=sqrt((iq1-iqcent)^2+(iq2-iqcent)^2)+1; % +1: prevent Iscatt(iqabs=0)          iqabs=round(qabs);         ishar=qabs-iqabs;         share=abs(ishar);	% how much to share         isignshare=sign(ishar);  % +1 if q > iq; 0 if exactly on         addI=Iq(iq1,iq2)*formx*formy;  %sincsqr: effect of elementary square         temp1(iqabs)=addI*(1-share);         temp1(iqabs+isignshare)=addI*share; % 0 if exactly on        end    end    Iscatt = Iscatt + temp1;end% ----------------------------------------% calculate I(q)% ----------------------------------------Isum=0;parfor iq=2:nxfd2 Isum=Isum+Iscatt(iq); In(iq-1)=Iscatt(iq)/(iq-1)^2;  %iq=0 really q=0 %In2D(iq-1)=Iscatt(iq)/(iq-1);  %in-plane averagingendend